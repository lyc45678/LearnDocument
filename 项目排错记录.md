#### 错误一：

```bash
root@liuchong:/# nginx -t
nginx: [alert] could not open error log file: open() "/var/log/nginx/error.log" failed (2: No such file or directory)
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
2025/10/10 21:14:58 [emerg] 50715#0: open() "/var/log/nginx/error.log" failed (2: No such file or directory)
nginx: configuration file /etc/nginx/nginx.conf test failed
```

##### 错误原因：

 Nginx 需要的日志目录不存在

##### 解决方案：

- 检查Nginx配置中的用户配置

```
head -n 5 /etc/nginx/nginx.conf
```

- 创建必要的目录结构

```
# 创建 Nginx 日志目录
sudo mkdir -p /var/log/nginx
```

- 设置正确的权限

```
# 设置 root 用户对日志目录的权限
sudo chown -R root:root /var/log/nginx
```

桥接模式需要建立桥接器虚拟网卡

##### 安装银河麒麟系统需要修改的配置

1.创建/confbak目录，养成修改配置文件提前备份习惯

```cpp
mkdir /confbak
cp /etc/selinux/config /confbak
```

2.执行命令关闭

```bash
systemctl stop firewalld
systemctl disable firewalld
setenforce 0
sed -i 's/enforcing/disabled/g' /etc/selinux/config
```

3.网络配置

1.查看自己的网卡名称

```bash
ip a|grep ens |awk '{print $2}'
```

一般是ens33

2.备份

```bash
cp /etc/sysconfig/network-scripts/ifcfg-ens33 /confbak
```

3.执行以下命令，如上一步网卡名字是其他将ens33手动改为其他执行

```bash
echo "IPADDR=192.168.8.10" >> /etc/sysconfig/network-scripts/ifcfg-ens33
echo "NETMASK=255.255.255.0" >> /etc/sysconfig/network-scripts/ifcfg-ens33
echo "GATEWAY=192.168.8.2" >> /etc/sysconfig/network-scripts/ifcfg-ens33
echo "DNS1=8.8.8.8" >> /etc/sysconfig/network-scripts/ifcfg-ens33
echo "DNS2=114.114.114.114" >> /etc/sysconfig/network-scripts/ifcfg-ens33
sed -i 's/IPV6/#&/' /etc/sysconfig/network-scripts/ifcfg-ens33
sed -i 's/dhcp/static/' /etc/sysconfig/network-scripts/ifcfg-ens33
sed -i 's/ONBOOT=no/ONBOOT=yes/' /etc/sysconfig/network-scripts/ifcfg-ens33
```

注：最后一行命令是解决每次开机网卡不能启动 需要手动才能起来，ONBOOT由no改为yes解决

4.重启网卡生效配置

```bash
systemctl restart network
```

注意网卡少用ifdown 或者systemctl stop，生产环境大多不是直连服务器，down掉起不来就得让机房直连......

七、可使用cockpit通过web页面管理监控

麒麟v10也自带了Cockpit，Cockpit 是一个开源的服务器管理工具，主要用于简化 Linux服务器 的管理和监控。它提供了一个基于Web的用户界面，使系统管理员能够通过网页浏览器轻松地管理和监控服务器的状态、性能和配置‌‌。

1.确认防火墙已禁用

2.启动cockpit

```bash
systemctl enable --now cockpit.socket
```

成功会返回

Created symlink /etc/systemd/system/sockets.target.wants/cockpit.socket → /usr/lib/systemd/system/cockpit.socket.

3.浏览器访问

https://192.168.8.10:9090,填写用户名及密码

#### 安装VMtools

- **挂载VMware Tools光盘** 在VMware Workstation中，点击菜单栏的 虚拟机 > 安装 VMware Tools。 系统会自动加载一个包含安装包的虚拟光盘。

- **复制安装包** 打开虚拟机中的光驱目录，找到 VMwareTools-<版本号>.tar.gz 文件。 使用以下命令将其复制到 /opt/ 目录： cp /mnt/cdrom/VMwareTools-*.tar.gz /opt/

- **解压安装包** 进入 /opt/ 目录并解压文件： cd /opt/ tar -xvf VMwareTools-*.tar.gz

- **运行安装脚本** 进入解压后的目录 vmware-tools-distrib： cd vmware-tools-distrib 执行安装脚本： sudo ./vmware-install.pl 按提示一路回车完成安装。

- **重启虚拟机** 安装完成后，重启系统以应用更改： sudo reboot

打开ens33网卡，运行yum install -y open-vm-tools open-vm-tools-desktop即可

虚拟机网络问题：

重启网络：systemctl restart NetworkManager

在window上配置虚拟网卡，与虚拟机上的网卡配置相同即可

#### 安装tomcat

宿主机向虚拟机中传输文件可以开启共享文件夹，指定对应主机路径即可，在虚拟机中访问/mnt/hgfs

拿到对应的tar包，在指定目录下解压即可

tar -xvf apache-tomcat-7.0.0.104.tar.gz -C /opt/java

![image-20251014163440164](https://cdn.jsdelivr.net/gh/lyc45678/image@master/img/20251014163514213.png)

使配置文件生效source ~/.bashrc

问题发现：

将文件拷入webapps目录后，发现无法正常打开

经过查看日志得出，数据库连接失败

经过查询发现rs5000用户未创建，创建之后重启Tomcat，问题解决

在网址上访问权限服务，发现显示页面过期等错误

经过帮忙，将mysql数据库区分大小写关闭即可。

#### 配置JDK

同样是在宿主机下载tar包，放在share目录下，再由虚拟机去解压得到对应jdk安装包

tar -xvf jdk1.8.0_461.tar.gz -C /opt/java

配置环境变量

![image-20251014171702132](https://cdn.jsdelivr.net/gh/lyc45678/image@master/img/20251014171954166.png)

刷新配置文件生效source /etc/profile

#### 安装Nginx

检查依赖

gcc\make 等编译工具

```csharp
[root@localhost ~]# gcc --version
```

> gcc (GCC) 7.3.0
> Copyright © 2017 Free Software Foundation, Inc.
> 本程序是自由软件；请参看源代码的版权声明。本软件没有任何担保；
> 包括没有适销性和某一专用目的下的适用性担保。

已安装。

```csharp
[root@localhost ~]# make --version
```

> GNU Make 4.3
> 为 x86_64-koji-linux-gnu 编译
> Copyright (C) 1988-2020 Free Software Foundation, Inc.
> 许可证：GPLv3+：GNU 通用公共许可证第 3 版或更新版本http://gnu.org/licenses/gpl.html。
> 本软件是自由软件：您可以自由修改和重新发布它。
> 在法律允许的范围内没有其他保证。

已安装。

检查 PCRE 库

```csharp
[root@localhost ~]# pcre-config --version
```

> 8.44

已安装。

检查 zlib 库

```cpp
[root@localhost ~]# ls /usr/include/zlib.h 2>/dev/null && echo "✓ zlib 头文件存在" || echo "✗ zlib 头文件缺失"
```

> /usr/include/zlib.h
> ✓ zlib 头文件存在

已安装。

检查 OpenSSL 库

```undefined
openssl version
```

> OpenSSL 1.1.1f 31 Mar 2020

已安装。

安装Nginx

```undefined
tar -zxvf nginx-1.24.0.tar.gz -C /opt/java
```

切换到 nginx 的目录内。从源代码编译安装。这个过程中会输出一堆编译过程。

```bash
cd /opt/java/nginx-1.24.0
./configure && make && make install
```

验证安装 nginx 是否成功。

```bash
/usr/local/nginx/sbin/nginx -v
```

> nginx version: nginx/1.24.0

启动 nginx。

```bash
/usr/local/nginx/sbin/nginx
```

检查是否启动成功。

```xml
[root@localhost nginx-1.24.0]# curl http://localhost
```

![image-20251014221828089](https://cdn.jsdelivr.net/gh/lyc45678/image@master/img/20251014221828179.png)

**配置 nginx 为系统服务**

编辑 service 文件。

```bash
vim /usr/lib/systemd/system/nginx.service
```

保存下面内容到 service 文件中。

```ini
[Unit]
Description=nginx service
After=network.target

[Service]
Type=forking
ExecStart=/usr/local/nginx/sbin/nginx
ExecReload=/usr/local/nginx/sbin/nginx -s reload
ExecStop=/usr/local/nginx/sbin/nginx -s stop
PrivateTmp=true

[Install]
WantedBy=multi-user.target
```

重新加载 systemd 的单元配置文件。

```undefined
systemctl daemon-reload
```

启动 nginx 服务。

```sql
systemctl start nginx.service
```

如果提示下面这段，可能是你前面启动 nginx 忘记停掉了。

> Job for nginx.service failed because the control process exited with error code.
> See "systemctl status nginx.service" and "journalctl -xe" for details.

查看服务状态。

```lua
systemctl status nginx.service
```

将服务配置为开机启动。

```bash
systemctl enable nginx.service
```

> Created symlink /etc/systemd/system/multi-user.target.wants/nginx.service → /usr/lib/systemd/system/nginx.service.

查看配置文件位置。

```bash
/usr/local/nginx/sbin/nginx -t
# 通过返回结果查看配置文件 这个命令其实是用于检测配置文件是否合法
```

> nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok
> nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful

修改Nginx配置文件

使用对应项目的配置文件

使用scp命令

```
scp /etc/nginx/conf.d/nginxserver.conf root@192.168.16.10:/opt/java/share
```

拿到配置文件之后，

在/usr/local/nginx/conf/nginx.conf中在http{}块之内，server{}块之外添加

```
include /usr/local/nginx/conf/nginxserver.conf
```

然后nginx-t检测，可以成功运行

##### 配置日志文件

启动日志配置

在 `nginx.conf` 的 `http` 块中添加：

nginx.conf

```
http {
    # 定义日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    log_format extended '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for" '
                        '"$request_time" "$upstream_response_time"';

    # 启用访问日志和错误日志
    access_log /var/log/nginx/access.log main;
    error_log  /var/log/nginx/error.log warn;
    
    # 其他配置...
}
```

Server块中的日志配置

nginx

```conf
server {
    listen       80;
    server_name  localhost;

    # 当前server的访问日志
    access_log  /var/log/nginx/host.access.log main;
    access_log  /var/log/nginx/host.access-extended.log extended;
    
    # 当前server的错误日志
    error_log   /var/log/nginx/host.error.log notice;

    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
    }
```

创建日志目录和设置权限

```xml
# 创建日志目录
mkdir -p /var/log/nginx

# 设置权限
chown -R nginx:nginx /var/log/nginx
chmod 755 /var/log/nginx

# 创建日志文件
touch /var/log/nginx/{access,error,localhost.access,localhost.error,api.access}.log
chown nginx:nginx /var/log/nginx/*.log
```

立即生效配置

```
# 1. 检查配置语法
nginx -t

# 2. 重新加载配置
nginx -s reload
```







#### 安装MySQL

1) 查看是否已安装 mariadb，若是已安装，需要卸载

```
# rpm -qa|grep mariad
```

要是有，卸载 mariadb

```
# yum remove mariad
```

解压

```bash
tar -zxvf mysql-5.7.18-linux-glibc2.5-x86_64.tar.gz -C /opt/java
```

创建mysql存储数据目录

```bash 
mkdir data
```

 赋予权限

```bash
chown mysql:mysql -R  /opt/java/mysql-5.7.18-linux-glibc2.5-x86_64/data/
```

编辑my.cnf文件 `vim /etc/my.cnf`

```
[mysqld]
# 设置3306端口
port=3306
# 设置mysql的安装目录
basedir=``/usr/local/mysql
# 设置mysql数据库的数据的存放目录
datadir=``/usr/local/mysql/data
# 允许最大连接数
max_connections=200
# 允许连接失败的次数。
max_connect_errors=10
# 服务端使用的字符集默认为utf8mb4
character-``set``-server=utf8mb4
# 创建新表时将使用的默认存储引擎
default-storage-engine=INNODB
# 默认使用“mysql_native_password”插件认证
#mysql_native_password
default_authentication_plugin=mysql_native_password
[mysql]
# 设置mysql客户端默认字符集
default-character-``set``=utf8mb4
[client]
# 设置mysql客户端连接服务端时默认使用的端口
port=3306
default-character-``set``=utf8mb4
```

在bin目录下初始化MySQL

```bash
./mysqld --defaults-file=/etc/my.cnf --basedir=/opt/java/mysql-5.7.18-linux-glibc2.5-x86_64 --datadir=/opt/java/mysql-5.7.18-linux-glibc2.5-x86_64/data --user=mysql --initialize
```

初始密码：.z4u%p.(PDC#

启动MySQL

```bash
[root@localhost mysql-5.7.18-linux-glibc2.5-x86_64]# support-files/mysql.server start
Starting MySQL.Logging to '/opt/java/mysql-5.7.18-linux-glibc2.5-x86_64/data/localhost.localdomain.err'.
.. SUCCESS! 
```

```
修改初始密码
切换目录
``cd /usr/local/mysql/bin``
登录命令
``./mysql-u root -p``
```



```
# 设置密码
SET PASSWORD = PASSWORD(``'ok'``);
# 设置用户的访问密码用不过期
ALTER USER ``'root'``@``'localhost'` `PASSWORD EXPIRE NEVER;
#刷新权限
FLUSH PRIVILEGES;
```

datagrip无法连接虚拟机数据库

```
-- 或者修改现有root用户的host
UPDATE mysql.user SET host='%' WHERE user='root';

-- 刷新权限
FLUSH PRIVILEGES;
```

重启MySQL之后即可。

创建systemd服务文件

```
vi /usr/lib/systemd/system/mysql.service
```

在文件中添加以下配置

```
[Unit]
Description=MySQL Server
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target

[Install]
WantedBy=multi-user.target

[Service]
User=mysql
Group=mysql

# 根据您的安装路径修改
Type=forking
PIDFile=/opt/java/mysql-5.7.18-linux-glibc2.5-x86_64/data/mysqld.pid

# 启动命令
ExecStart=/opt/java/mysql-5.7.18-linux-glibc2.5-x86_64/bin/mysqld --defaults-file=/etc/my.cnf --daemonize

# 停止命令
ExecStop=/opt/java/mysql-5.7.18-linux-glibc2.5-x86_64/bin/mysqladmin -uroot -p shutdown

# 重启命令
ExecReload=/bin/kill -HUP $MAINPID

# 限制资源使用
LimitNOFILE=5000

Restart=on-failure
RestartPreventExitStatus=1
PrivateTmp=false
```

重新加载systemd并启用服务

```
# 重新加载systemd配置
systemctl daemon-reload

# 设置开机自启
systemctl enable mysql.service

# 启动MySQL服务
systemctl start mysql.service

# 检查状态
systemctl status mysql.service
```

常用管理命令

bash

```
# 启动
systemctl start mysql

# 停止
systemctl stop mysql

# 重启
systemctl restart mysql

# 查看状态
systemctl status mysql

# 查看日志
journalctl -u mysql.service -f
```

发现报错

没有PID文件

解决过程：

检查MySQL配置中的PID文件设置

发现没有，决定添加

```
vim /etc/my.cnf
```

在 `[mysqld]` 部分添加：

```
[mysqld]
pid-file = /opt/java/mysql-5.7.18-linux-glibc2.5-x86_64/data/mysqld.pid
```

手动创建PID文件

```
# 获取MySQL进程ID
MYSQL_PID=$(ps aux | grep mysqld | grep -v grep | awk '{print $2}')
echo "MySQL进程ID: $MYSQL_PID"

# 创建PID文件
echo $MYSQL_PID > /opt/java/mysql-5.7.18-linux-glibc2.5-x86_64/data/mysqld.pid

# 设置正确的权限
chown mysql:mysql /opt/java/mysql-5.7.18-linux-glibc2.5-x86_64/data/mysqld.pid
chmod 644 /opt/java/mysql-5.7.18-linux-glibc2.5-x86_64/data/mysqld.pid
```

修改systemd服务文件

修改为

```
[Unit]
Description=MySQL Server
After=network.target

[Service]
Type=simple
User=mysql
Group=mysql
ExecStart=/opt/java/mysql-5.7.18-linux-glibc2.5-x86_64/bin/mysqld --defaults-file=/etc/my.cnf
ExecStop=/opt/java/mysql-5.7.18-linux-glibc2.5-x86_64/bin/mysqladmin -uroot -p shutdown
Restart=on-failure
RestartSec=10
TimeoutSec=300

[Install]
WantedBy=multi-user.target
```

重新加载并重启服务

问题解决

设置mysql-u root -p 

```
# 添加到 ~/.bashrc
echo 'export PATH=/opt/java/mysql-5.7.18-linux-glibc2.5-x86_64/bin:$PATH' >> ~/.bashrc
echo 'export PATH=/opt/java/jdk1.8.0_461/bin:$PATH' >> ~/.bashrc

# 重新加载配置
source ~/.bashrc

# 现在可以直接使用
mysql -u root -p
```

报错：由于版本的sql_mode并没有关闭，

在配置文件中修改sql_mode。

重启服务

#### 安装nacos

从官网上下载zip压缩包在进行解压。

在bin目录下启动单机模式

```
sh startup.sh -m standalone
```

开启nacos鉴权

修改nacos配置文件

```
# 开启认证
nacos.core.auth.enabled=true
nacos.core.auth.system.type=nacos

# 设置 Token 密钥（自定义，长度至少32位）
nacos.core.auth.plugin.nacos.token.secret.key=SecretKey012345678901234567890123456789012345678901234567890123456789

# 缓存配置
nacos.core.auth.plugin.nacos.token.expire.seconds=18000
nacos.core.auth.caching.enabled=true
```

重启服务

./shutdown.sh

再次启动单机模式

**sh startup.sh -m standalone**

nacos密钥：VGhpc0lzQVNlY3JldEtleUZvck5hY29zQXV0aFBsdWdpbjAyMzQ1Njc4OTAxMjM0NTY3ODkw

运行报错

Whitelabel Error Page

This application has no explicit mapping for /error, so you are seeing this as a fallback.
Fri Oct 17 09:35:46 CST 2025
There was an unexpected error (type=Forbidden, status=403).
Invalid server identity key or value, Please make sure set `nacos.core.auth.server.identity.key` and `nacos.core.auth.server.identity.value`, or open `nacos.core.auth.enable.userAgentAuthWhite`

修改配置文件

```
nacos.core.auth.server.identity.key=serverIdentity
nacos.core.auth.server.identity.value=security
```

重启服务

问题解决

#### 运行jar包

报错，发现数据库用户rs5000无法连接ora9a数据库

解决方案：进入MySQL中授权

mysql> GRANT ALL PRIVILEGES ON ora9a.* TO 'rs5000'@'localhost';
Query OK, 0 rows affected (0.11 sec)

mysql> FLUSH PRIVILEGES;
Query OK, 0 rows affected (0.14 sec)

使用tmux工具

创建运行jar包脚本

创建脚本，开机自启

##### 服务1：sec-countermeasures

```
sudo vim /etc/systemd/system/sec-countermeasures.service
```

```
[Unit]
Description=Sec Countermeasures Service
After=network.target mysql.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/java/springboot/sec-countermeasures
ExecStart=/opt/java/jdk1.8.0_461/bin/java -jar sec-countermeasures.jar
ExecStop=/bin/kill -15 $MAINPID
Restart=always
RestartSec=10
SuccessExitStatus=143

Environment=JAVA_HOME=/opt/java/jdk1.8.0_461

[Install]
WantedBy=multi-user.target
```



##### 服务2：sec-data-maintenance

```
sudo vim /etc/systemd/system/sec-data-maintenance.service
```

```
[Unit]
Description=Sec Data Maintenance Service
After=network.target mysql.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/java/springboot/sec-data-maintenance
ExecStart=/opt/java/jdk1.8.0_461/bin/java -jar sec-data-maintenance.jar
ExecStop=/bin/kill -15 $MAINPID
Restart=always
RestartSec=10
SuccessExitStatus=143

Environment=JAVA_HOME=/opt/java/jdk1.8.0_461

[Install]
WantedBy=multi-user.target
```



##### 服务3：sec-inspection

```
sudo vim /etc/systemd/system/sec-inspection.service
```

```
[Unit]
Description=Sec Inspection Service
After=network.target mysql.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/java/springboot/sec-inspection
ExecStart=/opt/java/jdk1.8.0_461/bin/java -jar sec-inspection.jar
ExecStop=/bin/kill -15 $MAINPID
Restart=always
RestartSec=10
SuccessExitStatus=143

Environment=JAVA_HOME=/opt/java/jdk1.8.0_461

[Install]
WantedBy=multi-user.target
```



##### 服务4：sec-panoramic

```
sudo vim /etc/systemd/system/sec-panoramic.service
```

```
[Unit]
Description=Sec Panoramic Service
After=network.target mysql.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/java/springboot/sec-panoramic
ExecStart=/opt/java/jdk1.8.0_461/bin/java -jar sec-panoramic.jar
ExecStop=/bin/kill -15 $MAINPID
Restart=always
RestartSec=10
SuccessExitStatus=143

Environment=JAVA_HOME=/opt/java/jdk1.8.0_461

[Install]
WantedBy=multi-user.target
```



##### 服务5：sec-central-monitor（根目录的）

```
sudo vim /etc/systemd/system/sec-central-monitor.service
```

```
[Unit]
Description=Sec Central Monitor Service
After=network.target mysql.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/java/springboot
ExecStart=/opt/java/jdk1.8.0_461/bin/java -jar sec_central_monitor-1.0-SNAPSHOT.jar
ExecStop=/bin/kill -15 $MAINPID
Restart=always
RestartSec=10
SuccessExitStatus=143

Environment=JAVA_HOME=/opt/java/jdk1.8.0_461

[Install]
WantedBy=multi-user.target
```

##### 2. 启用和启动所有服务

```
# 重新加载 systemd
sudo systemctl daemon-reload

# 启用所有服务开机自启
sudo systemctl enable sec-central-monitor.service
sudo systemctl enable sec-countermeasures.service
sudo systemctl enable sec-data-maintenance.service
sudo systemctl enable sec-inspection.service
sudo systemctl enable sec-panoramic.service

# 启动所有服务
sudo systemctl start sec-central-monitor.service
sudo systemctl start sec-countermeasures.service
sudo systemctl start sec-data-maintenance.service
sudo systemctl start sec-inspection.service
sudo systemctl start sec-panoramic.service
```



##### 3. 检查服务状态

```
# 检查所有服务状态
sudo systemctl status sec-central-monitor.service
sudo systemctl status sec-countermeasures.service
sudo systemctl status sec-data-maintenance.service
sudo systemctl status sec-inspection.service
sudo systemctl status sec-panoramic.service

# 或者一键查看所有状态
for service in sec-central-monitor sec-countermeasures sec-data-maintenance sec-inspection sec-panoramic; do
    echo "=== $service ==="
    sudo systemctl status $service.service --no-pager -l
    echo
done
```



##### 4. 创建统一管理脚本

```
# 创建管理脚本
sudo vim /usr/local/bin/manage-jars
```

```
#!/bin/bash

SERVICES=(
    "sec-central-monitor"
    "sec-countermeasures" 
    "sec-data-maintenance"
    "sec-inspection"
    "sec-panoramic"
)

case "$1" in
    start)
        for service in "${SERVICES[@]}"; do
            echo "启动 $service..."
            sudo systemctl start $service.service
        done
        ;;
    stop)
        for service in "${SERVICES[@]}"; do
            echo "停止 $service..."
            sudo systemctl stop $service.service
        done
        ;;
    restart)
        for service in "${SERVICES[@]}"; do
            echo "重启 $service..."
            sudo systemctl restart $service.service
        done
        ;;
    status)
        for service in "${SERVICES[@]}"; do
            echo -n "$service: "
            if sudo systemctl is-active --quiet $service.service; then
                echo -e "\033[32m运行中\033[0m"
            else
                echo -e "\033[31m未运行\033[0m"
            fi
        done
        ;;
    enable)
        for service in "${SERVICES[@]}"; do
            echo "启用 $service 开机自启..."
            sudo systemctl enable $service.service
        done
        ;;
    disable)
        for service in "${SERVICES[@]}"; do
            echo "禁用 $service 开机自启..."
            sudo systemctl disable $service.service
        done
        ;;
    logs)
        if [ -z "$2" ]; then
            echo "用法: manage-jars logs <服务名>"
            echo "可用服务: ${SERVICES[*]}"
        else
            sudo journalctl -u $2.service -f
        fi
        ;;
    *)
        echo "用法: manage-jars {start|stop|restart|status|enable|disable|logs}"
        echo "可用服务:"
        for service in "${SERVICES[@]}"; do
            echo "  - $service"
        done
        ;;
esac
```



```
# 设置执行权限
sudo chmod +x /usr/local/bin/manage-jars
```



##### 5. 使用管理脚本

```
# 启动所有服务
manage-jars start

# 查看状态
manage-jars status

# 重启所有服务
manage-jars restart

# 查看某个服务的日志
manage-jars logs sec-central-monitor

# 启用开机自启
manage-jars enable
```

##### jar包日志文件

###### 1. 创建日志目录

bash

```
sudo mkdir -p /var/log/sec
sudo chmod 755 /var/log/sec
```



###### 2. 修改服务文件添加日志配置

bash

```
 vim /etc/systemd/system/sec-central-monitor.service
```

**在 `Environment=JAVA_HOME...` 这一行之前添加：**

```
StandardOutput=file:/var/log/sec/central-monitor.log
StandardError=file:/var/log/sec/central-monitor-error.log
```



###### 3. 重新加载并启动服务

bash

```
# 重新加载systemd配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start sec-central-monitor

# 检查服务状态
sudo systemctl status sec-central-monitor

# 查看日志是否生成
ls -la /var/log/sec/

# 实时查看日志
tail -f /var/log/sec/central-monitor.log
```



###### **批量修改所有 sec 服务**

如果您想为所有 sec 服务添加日志配置：

```
# 创建批量修改脚本
sudo vim /tmp/add-logs-to-sec.sh
```

```
#!/bin/bash
SERVICES=("sec-central-monitor" "sec-countermeasures" "sec-data-maintenance" "sec-inspection" "sec-panoramic")

for service in "${SERVICES[@]}"; do
    service_file="/etc/systemd/system/${service}.service"
    
    if [[ -f "$service_file" ]]; then
        echo "处理服务: $service"
        
        # 停止服务
        sudo systemctl stop "$service"
        
        # 备份
        sudo cp "$service_file" "${service_file}.backup.$(date +%Y%m%d%H%M%S)"
        
        # 添加日志配置（在Environment行之前）
        sudo sed -i '/^Environment=.*$/i StandardOutput=file:/var/log/sec/'"${service#sec-}"'.log' "$service_file"
        sudo sed -i '/^Environment=.*$/i StandardError=file:/var/log/sec/'"${service#sec-}"'-error.log' "$service_file"
        
        echo "  - 已添加日志配置"
    else
        echo "跳过: $service_file 不存在"
    fi
done

# 重新加载并启动服务
sudo systemctl daemon-reload
for service in "${SERVICES[@]}"; do
    if [[ -f "/etc/systemd/system/${service}.service" ]]; then
        sudo systemctl start "$service"
        echo "启动服务: $service"
    fi
done

echo "完成!"
```

```
# 执行脚本
chmod +x /tmp/add-logs-to-sec.sh
sudo /tmp/add-logs-to-sec.sh
```

##### 日志轮转设置

######  1.**创建 logrotate 配置**

bash

```
sudo vim /etc/logrotate.d/sec-services
```

bash

```
/var/log/sec/*.log {
    daily                      # 每天轮转
    missingok                  # 如果日志文件丢失，不报错
    rotate 30                  # 保留30天的日志
    compress                   # 压缩旧日志
    delaycompress              # 延迟压缩（下一次轮转时压缩）
    notifempty                 # 如果日志为空，不轮转
    copytruncate               # 复制后截断原文件
    dateext                    # 使用日期作为后缀
    dateformat -%Y%m%d         # 日期格式
    size 100M                  # 达到100MB也轮转
}
```



###### **2. 测试配置**

bash

```
# 测试配置文件语法
sudo logrotate -d /etc/logrotate.d/sec-services

# 手动立即执行轮转
sudo logrotate -vf /etc/logrotate.d/sec-services
```



#### 使用 systemd 流程（以tmux举例说明）

```
# 创建服务文件
sudo vim /etc/systemd/system/tmux-jar.service
```

内容：

```
[Unit]
Description=Start JAR in tmux session
After=network.target

[Service]
Type=forking
User=root
ExecStart=/usr/bin/tmux new-session -d -s jar-service -c /root/springboot '/home/lch/jdk1.8.0_371/bin/java -jar sec_central_monitor-1.0-SNAPSHOT.jar'
ExecStop=/usr/bin/tmux kill-session -t jar-service

[Install]
WantedBy=multi-user.target
```

启用服务：

```
sudo systemctl daemon-reload
sudo systemctl enable tmux-jar.service
sudo systemctl start tmux-jar.service
```

#### 数据完备功能无法访问

原因：rs5000是普通用户，所以不给具体的数据库赋权限就无法使用。

因此需要给其赋权限



git操作：找到自己原先修改并提交

```bash
git status # 查看状态可以看到有多少提交
git log --online -num
# 1. 重置到远程最新状态（7f68740b）
PS F:\WorkProject\yunNanWeb> git reset --soft 7f68740b

# 2. 查看状态 - 应该只显示智慧调度模块的修改文件
PS F:\WorkProject\yunNanWeb> git status

# 3. 提交智慧调度模块的修改
PS F:\WorkProject\yunNanWeb> git commit -m "智慧调度模块反措（专项）管理改动"

# 4. 推送
PS F:\WorkProject\yunNanWeb> git push origin master
```

### 安装mycat

解压tar包到指定目录下

```
tar -xzf Mycat-server-1.6.7.5-release-20200422133810-linux.tar.gz -C /usr/local
```

将配置文件覆盖上去

```bash
cp /mnt/hgfs/share/partition-enum.txt /usr/local/mycat/conf
cp /mnt/hgfs/share/rule.xml /usr/local/mycat/conf
cp /mnt/hgfs/share/schema.xml /usr/local/mycat/conf
cp /mnt/hgfs/share/server.xml /usr/local/mycat/conf
cp /mnt/hgfs/share/sharding-by-enum.txt /usr/local/mycat/conf
```

配置文件详情：

#### server.xml

```xml
<!--分布式事务开关，0为不过滤分布式事务，1为过滤分布式事务（如果分布式事务内只涉及全局表，则不过滤），2为不过滤分布式事务,但是记录分布式事务日志-->
		<property name="handleDistributedTransactions">0</property>
指定端口8066
		<property name="serverPort">8066</property> 
		<property name="managerPort">9066</property>
```

```xml
<user name="rs5000" defaultAccount="true">
		<property name="password">rs5000</property>
		<property name="schemas">dbcenter</property>
		<property name="defaultSchema">dbcenter</property>
		<!--No MyCAT Database selected 错误前会尝试使用该schema作为schema，不设置则为null,报错 -->
    mycat启动后会将所有数据库集成为一个库就是dbcenter
```

#### schema.xml

```xml
<?xml version="1.0"?>
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">
<mycat:schema xmlns:mycat="http://io.mycat/">

	<schema name="dbcenter" checkSQLschema="true" sqlMaxLimit="100" >
		<!-- auto sharding by id (long) -->
		<!--splitTableNames 启用<table name 属性使用逗号分割配置多个表,即多个表使用这个配置-->
		<!--fetchStoreNodeByJdbc 启用ER表使用JDBC方式获取DataNode-->

		
		<!--table name="TB0000_DATABASE,TB0001_SRVTYPE,TB0002_USER,TB0003_NODE,TB0004_USERGROUP,TB0005_SRVCFG,TB0006_SRVPROC,
		TB0007_HOSTPROC,TB0008_EVTDEALMODE,TB0008_RIGHT,TB0009_EVTEXPRESS,TB0009_NODERIGHT,TB0009_USERGROUPRIGHT,TB0010_EVTSORT,
		TB0010_EVTTYPE,TB0011_EVTNOTIFYTYPE,TB0013_SRVSTATUS,TB0014_HOSTSTATUS,TB0017_RDBTABLE,TB0018_RDBFIELD,TB0019_TBLDICT,
		TB0020_FLDDICT,TB0021_RDBMIRROR,TB0022_SYNRTDB ,TB0023_ACCORDTAB,TB0024_SYNTABLE,TB0025_TABLEDESC,TB0026_EVTSTATUSDESC,
		TB0027_EVTTYPELEVEL,TB0037_APPREG,TB1001_DEVTYPE,TB1011_MEASTYPE"  dataNode="dn$0-16"  splitTableNames="true"/-->	
    
			<table name="TB1038_AREA" primaryKey="F1038_CODE" dataNode="dn$0-1" rule="sharding-by-enum" needAddLimit="false"/>
		<table name="TB1040_PATROLCENTER" primaryKey="F1040_CODE" dataNode="dn$0-1" rule="sharding-by-enum" needAddLimit="false"/>
		<table name="TB1041_SUBSTATION" primaryKey="F1041_CODE" dataNode="dn$0-1" rule="sharding-by-enum" needAddLimit="false">
			<childTable name="TB1006_ANALOGDATA" primaryKey="F1006_CODE" joinKey="F1041_CODE" parentKey="F1041_CODE" needAddLimit="false"/> 
			<childTable name="TB1016_STATEDATA" primaryKey="F1016_CODE" joinKey="F1041_CODE" parentKey="F1041_CODE" needAddLimit="false"/>
			<childTable name="TB1026_STRINGDATA" primaryKey="F1026_CODE" joinKey="F1041_CODE" parentKey="F1041_CODE" needAddLimit="false"/>
			<childTable name="TB1036_SETTINGDATA" primaryKey="F1036_CODE" joinKey="F1041_CODE" parentKey="F1041_CODE"  needAddLimit="false"/>
			<childTable name="TB1046_IED" primaryKey="F1046_CODE" joinKey="F1041_CODE" parentKey="F1041_CODE" needAddLimit="false"/> 
			<childTable name="TB1043_EQUIPMENT" primaryKey="F1046_CODE" joinKey="F1041_CODE" parentKey="F1041_CODE" needAddLimit="false"/> 
			<childTable name="TB1064_STRAP" primaryKey="F1046_CODE" joinKey="F1041_CODE" parentKey="F1041_CODE" needAddLimit="false"/> 
			<childTable name="TB1077_HARDSTRAP" primaryKey="F1077_CODE" joinKey="F1041_CODE" parentKey="F1041_CODE" needAddLimit="false"/>
			<childTable name="TB1080_SUBSTATIONUNIT" primaryKey="F1046_CODE" joinKey="F1041_CODE" parentKey="F1041_CODE" needAddLimit="false"/>
		</table>

			<table name="tb_faultproductionsupport_his" primaryKey="F1038_CODE" dataNode="dn$0-1" rule="sharding-by-enum" needAddLimit="false"/>
			<table name="ST_TB1046_IED" primaryKey="F1038_CODE" dataNode="dn$0-1" rule="sharding-by-enum" needAddLimit="false"/>
			<table name="TB1101_TAGGROUP" primaryKey="F1038_CODE" dataNode="dn$0-1" rule="sharding-by-enum" needAddLimit="false"/>
			<table name="TB1102_TAGITEM" primaryKey="F1038_CODE" dataNode="dn$0-1" rule="sharding-by-enum" needAddLimit="false"/>
			<table name="TB1107_TAGREPLACE" primaryKey="F1038_CODE" dataNode="dn$0-1" rule="sharding-by-enum" needAddLimit="false"/>
		<table name="tb_substation_stamp,TB_COMPREHENSIVE_APPROVAL_DEVICE,TB_COUNTER_ADVICE,TB_COUNTER_ATTACH,TB_COUNTER_DEVICE_COL,TB_COUNTER_PROJECT_REPORT,TB_TOUR_ATTACHMENT,TB_SUSPEND_RECORD,tb_commstatus_event,TB_RISK_SUPERVISION,TB_RISK_SUPERVISION_DEVICE,TB_RISK_SUPERVISION_RECORD,TB_COMPREHENSIVE_APPROVAL,TB_COMPREHENSIVE_APPROVAL_LOG,TB_COMPREHENSIVE_ATTACH,TB1038_REALAREA,temp_TB1036_SETTINGDATA,TB_TOUR_APPROVAL,TB_SETTING_SHEET_MODEL,TB_CANONICALNAME_APPROVAL,TB_SETTING_SHEET_FAILS,TB1075_STATERMIN,TB_HIS_ANALOG,TB_OMS_FILE_LIST,TB1046_IEDVALUE,TB_FAULTSHORTENDATA,tb_fault_process,tb_fault_connection,tb_fault_attach,TB_FAULTSHORTENEVENT,tb_fault_specification,tb_fault_action_filter,TB_FAULTDETAIL,tb_fault_overhaul,TB_ANALYFAULTDATA,tb_fault_time_format,tb_faultreport,tb_faultevent,TB_APPRAISE_SCORESETTING,TB_APPRAISE_SCORESETTINGRULE,TB_APPRAISE_SYSTEMSETTING,TB_APPRAISE_DEVICE,TB_APPRAISE_CONTENT,TB_APPRAISE_STATISTICS,TB_APPRAISE_HISSCORE,TB_MAINTENANCE_DEV,TB_MAINTENANCEAPP_SHEET,TB_COUNTER_DEVICE,TB_COUNTER_PROJECT,TB_TOUR_TASK,TB_TOUR_CONTENT,TB_TOUR_RANGE,TB_TOUR_REPORT,TB_TOUR_REPORT_CONTENT,TB_TOUR_IEDDETAILEDRESULTS,TB_TOUR_CONTENT_ITEM,TB_TOUR_CONTENT_EVENT,TB1021_SETTINGITEM,TB_HIS_EVENT,MASTER_SERVER_IP_LIST,TB_SETTING_SHEET,TB_SUSPEND_STATUS,TB_PLATE_VERIFICATION_RECORD,TB_ENUMRRATION,,TB1105_TAGRECORDS,TB1110_IEDTAGITEM,TB1111_CONFIRMTAGITEM,
		TB1300_STATSVAL,sys_oper_log,tb_change_shifts_log,tb_acceptance_problem_list,tb_acceptance_task,tb_accessory,tb_check_accept,
		tb_check_accept_problem_list,tb_defect_mgt,tb_feasibility_check,tb_first_design_check,tb_his_memorandum,TB_FILE_CONTEXT,
		tb_ca_design_check_standard_house,tb_scd_management_control,tb_file_signout_log,tb_task_dev_relation,tb_alarm_overhaul_auto_config,
		tb_defect_accessory,tb_defect_flow_log,TB_RISK_INQUIRY,TB_VIOLATIONS_LIST,tb_basic_info_condition,TB_PLATE_VERIFICATION,
		TB_PLATE_VERIFICATION_RECORD,tb_defect_support"  dataNode="dn$0-1"  splitTableNames="true" needAddLimit="false"/>
	</schema>
	<!-- 数据节点定义 -->
    
        
	<dataNode name="dn0" dataHost="dh0" database="ora9a"/> 
	<dataNode name="dn1" dataHost="dh0" database="ora9a1"/> 
	
	<dataHost name="dh0" maxCon="1000" minCon="10" balance="0" writeType="1" dbType="mysql" dbDriver="native" switchType="0"  slaveThreshold="100" >
		<heartbeat>select user()</heartbeat>
		<writeHost host="192.168.16.10" url="192.168.16.10:3306" user="rs5000" password="rs5000">
		</writeHost>
	</dataHost>
</mycat:schema>
```

逻辑架构：

```
MyCat (逻辑数据库: dbcenter)
    ↓
数据分片: dn0, dn1
    ↓
物理数据库: ora9a, ora9a1 (在同一MySQL实例 192.168.16.10)
```

##### Schema 配置

xml

```
<schema name="dbcenter" checkSQLschema="true" sqlMaxLimit="100">
```



- **逻辑数据库名**: `dbcenter`
- **自动去除Schema**: `checkSQLschema="true"`
- **默认查询限制**: `sqlMaxLimit="100"`（防止全表扫描）

##### 数据分片配置

xml

```
<dataNode name="dn0" dataHost="dh0" database="ora9a"/>
<dataNode name="dn1" dataHost="dh0" database="ora9a1"/>
```



- **dn0**: 指向物理数据库 `ora9a`
- **dn1**: 指向物理数据库 `ora9a1`
- **同一物理主机**: 都在 `192.168.16.10`

##### 物理数据源配置

xml

```
<dataHost name="dh0" maxCon="1000" minCon="10" balance="0" 
          writeType="1" dbType="mysql" dbDriver="native">
    <writeHost host="192.168.16.10" url="192.168.16.10:3306" 
               user="rs5000" password="rs5000"/>
</dataHost>
```



- **连接池**: 最大1000连接，最小10连接
- **无读写分离**: `balance="0"`
- **MySQL数据库**: 使用原生驱动

##### 父子表关系（ER表）

xml

```
<table name="TB1041_SUBSTATION" primaryKey="F1041_CODE" dataNode="dn$0-1" 
       rule="sharding-by-enum" needAddLimit="false">
    <childTable name="TB1006_ANALOGDATA" primaryKey="F1006_CODE" 
                joinKey="F1041_CODE" parentKey="F1041_CODE"/>
```



**业务含义**: 变电站(TB1041_SUBSTATION)作为父表，其相关的：

- 模拟量数据(TB1006_ANALOGDATA)
- 状态量数据(TB1016_STATEDATA)
- 二次装置(TB1046_IED)
- 一次设备(TB1043_EQUIPMENT)等

**确保关联数据在同一分片**，避免跨分片JOIN。

##### 分片规则

- **所有表**: `dataNode="dn$0-1"` + `rule="sharding-by-enum"`
- **枚举分片**: 根据某个枚举字段的值决定分配到 dn0 或 dn1

#### sharding-by-enum.txt

![image-20251106170440235](https://cdn.jsdelivr.net/gh/lyc45678/image@master/img/20251106170508020.png)

####  partition-enum.txt 

```txt
yunnan=0
honghe=1
```

#### rule.xml

##### 主要使用的分片规则

###### `sharding-by-enum` (枚举分片)

xml

```
<tableRule name="sharding-by-enum">
    <rule>
        <columns>F1038_CODE</columns>
        <algorithm>func-enum</algorithm>
    </rule>
</tableRule>
```



**用途**: 根据地区代码(F1038_CODE)进行分片
**对应函数**: `func-enum` → 使用 `partition-enum.txt` 映射文件

###### `sharding-by-mutil-fields` (多字段分片)

xml

```
<tableRule name="sharding-by-mutil-fields">
    <rule>
        <columns>F1041_CODE</columns>
        <algorithm>partbymonth</algorithm>
    </rule>
</tableRule>
```



**用途**: 根据变电站代码(F1041_CODE)按月分片

#####  **分片函数详解**

###### `func-enum` - 枚举分片

xml

```
<function name="func-enum" class="io.mycat.route.function.PartitionByFileMap">
    <property name="type">1</property>
    <property name="mapFile">partition-enum.txt</property>
</function>
```

**配置文件**: `partition-enum.txt`
**示例内容**:

```
yunnan=0
honghe=1
```



###### `partbymonth` - 按月分片

xml

```
<function name="partbymonth" class="io.mycat.route.function.PartitionByMonth">
    <property name="dateFormat">yyyy-MM-dd</property>
    <property name="sBeginDate">2024-01-01</property>
</function>
```



**用途**: 从2024年1月开始按月分片

###### 地区维度分片

xml

```
<!-- 使用 F1038_CODE (地区代码) -->
<tableRule name="sharding-by-enum">
    <columns>F1038_CODE</columns>
    <algorithm>func-enum</algorithm>
</tableRule>
```



**应用表**:

- `TB1038_AREA` (地区表)
- `TB1101_TAGGROUP` (标签组)
- `TB1102_TAGITEM` (标签项)

###### 变电站维度分片

xml

```
<!-- 使用 F1041_CODE (变电站代码) -->
<tableRule name="sharding-by-mutil-fields">
    <columns>F1041_CODE</columns>
    <algorithm>partbymonth</algorithm>
</tableRule>
```



**应用表**: `TB1041_SUBSTATION` 及其子表



### 启动mycat

```
[root@localhost mycat]# ./bin/mycat start
```

```
mysql -h 127.0.0.1 -P 8066 -u rs5000 -p'rs5000' 
```







### 部署rs5000系统

解压tar包到/opt/java/下，配置环境变量

```
tar -xvf rs5000_2025-11-06_144654(1).tar.gz -C /opt/java
```

```
tar -xvf qt.tar.gz -C /opt/java
```

```bash
vim ~/.bashrc
```

```
 export SYHHOME=/opt/java/rs5000
 export QTDIR=/opt/java/qt3.3.8
 export PATH=$SYHHOME/bin:$PATH
 export LD_LIBRARY_PATH=$SYHHOME/lib:$LIBRARY_PATH:$QTDIR/lib

```

注册：

```bash
./opt/java/rs5000/bin/register
```

得到一串数字：

2758D2158BB4AD676A666F15444EF770

获取注册码：

注册码:D8EA-EEA0-1287-0C24-6CF8-D7DF-A215-B942

输入dbtool

修改配置

![image-20251106203434328](https://cdn.jsdelivr.net/gh/lyc45678/image@master/img/20251106203515581.png)

可以在终端上输入hostname查看是否一致

配置服务进程

![image-20251106203614709](https://cdn.jsdelivr.net/gh/lyc45678/image@master/img/20251106203614923.png)

加上周期巡视，启动模式定时，启动顺序随机

配置完成

启动！

在终端上输入softbus即可。



问题解决：

首先先查询厂站表，1041表

查到指定的1041code后在去查询一次装置表1043表

查询之后再去查询1046表中有一次装置的设备数

在查询指定厂站中有二次设备，没有一次装置的设备数



































